<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MovieSwiper</title>
  <link rel="stylesheet" href="movieSwiper.css">
</head>
<body>
  <header>
  <h1>MOVIE SWIPER</h1>

    <div class="profile-menu">
      <button id="profileBtn"><span id="profilePicture"></span><span id="profileName"></span> <img src="../mainPage/img/arrowDown.png" alt="" id="arrowProfile"></button>
      <div id="dropdown" class="dropdown-content">
         <a href="#" id="sharedListBtn">Wsp√≥lna lista</a>
        <a href="#" id="logoutBtn">Wyloguj siƒô</a>
      </div>
    </div>
</header>


  <div class="swiper-container">
<div id="movieCard" class="movie-card"></div>

<div class="buttons" style="display: none;">
  <button id="dislikeBtn">‚ùå Nie</button>
  <button id="likeBtn">‚ù§Ô∏è Tak</button>
</div>

<button id="swipeAgain">SWIPE AGAIN!</button>
</div>


<button id="footerToggle" class="footer-toggle"><img src="../mainPage/img/arrow.png" alt=""></button>


<div id="footer" class="footer">
  <div class="footer-content">
    <h2>Menu</h2>
    <ul>
      <li><a href="../mainPage/mainSite.html"><img src="../mainPage/img/heart.png" alt="">Strona g≈Ç√≥wna</a></li>
      <li><a href="#">‚≠ê Najlepiej oceniane</a></li>
      <li><a href="#">üé¨ Ostatnio oglƒÖdane</a></li>
    </ul>
  </div>
</div>


  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>

 document.getElementById("likeBtn").addEventListener("click", () => saveSwipe("liked"));
document.getElementById("dislikeBtn").addEventListener("click", () => saveSwipe("disliked"));
const SUPABASE_URL = "https://hxaqbpcufdlzfhmgddds.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4YXFicGN1ZmRsemZobWdkZGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzY3ODQsImV4cCI6MjA3MjQxMjc4NH0.o38-3lqMWMAESf5I3oXaGXqTp1fXw6mkZ310b7-EhXo";
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

const API_KEY = "9b02e967dce99b746fc634d03605d150";
const currentUser = sessionStorage.getItem("currentUser") || "guest";
let otherUser = ""
if(currentUser == "Julcia")
{
    otherUser = "Emi≈õ"
}
else
{
    otherUser = "Julcia"
}
let sharedMovies = [];
let currentIndex = 0;
 document.getElementById("logoutBtn").addEventListener("click", () => {
      // usu≈Ñ zapisany userId
      sessionStorage.removeItem("currentUser");
      // przekieruj na stronƒô logowania
      window.location.href = "../index.html"; // lub "login.html" je≈õli masz osobnƒÖ stronƒô logowania
    });


    // Zamknij dropdown je≈õli klikniesz poza nim
    window.addEventListener("click", (e) => {
      if (!profileBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = "none";
      }
    });
async function fetchSharedItem(item) {
  let url = "";

  if(item.type === "movie") {
    url = `https://api.themoviedb.org/3/movie/${item.movie_id}?api_key=${API_KEY}&language=pl-PL`;
  } else if(item.type === "tv") {
    url = `https://api.themoviedb.org/3/tv/${item.movie_id}?api_key=${API_KEY}&language=pl-PL`;
  } else if(item.type === "anime") {
    // je≈õli traktujesz anime jak film w TMDB
    url = `https://api.themoviedb.org/3/movie/${item.movie_id}?api_key=${API_KEY}&language=pl-PL`;
  }

  const res = await fetch(url);
  const data = await res.json();
  return data;
}


    showLikedMovies(otherUser)
  async function showLikedMovies(otherUser) {
  const container = document.getElementById("movieCard");
  container.innerHTML = "<h2>≈Åadowanie wsp√≥lnych polubionych film√≥w...</h2>";

  try {
    // Polubione przez Ciebie
    const { data: myLikes, error: myError } = await supabaseClient
      .from("swipes")
      .select("movie_id, type")
      .eq("action", "liked")
      .eq("user_id", currentUser);

    if (myError) throw myError;

    // Polubione przez drugiego u≈ºytkownika
    const { data: otherLikes, error: otherError } = await supabaseClient
      .from("swipes")
      .select("movie_id, type")
      .eq("action", "liked")
      .eq("user_id", otherUser);

    if (otherError) throw otherError;

    if (!myLikes.length || !otherLikes.length) {
      container.innerHTML = "<p>Brak wsp√≥lnych polubionych film√≥w üòÖ</p>";
      return;
    }

    // Przeciƒôcie po movie_id
    const myMovieIds = new Set(myLikes.map(m => m.movie_id));
    const mutualLikes = otherLikes.filter(m => myMovieIds.has(m.movie_id));

    if (mutualLikes.length === 0) {
      container.innerHTML = "<p>Brak wsp√≥lnych polubionych film√≥w üòÖ</p>";
      return;
    }

    container.innerHTML = "<h2>üé¨ Wsp√≥lnie polubione filmy:</h2>";
    const grid = document.createElement("div");
    grid.classList.add("liked-grid");

    // Pobierz szczeg√≥≈Çy z TMDB r√≥wnolegle
    await Promise.all(mutualLikes.map(async item => {
      const res = await fetch(`https://api.themoviedb.org/3/${item.type}/${item.movie_id}?api_key=${API_KEY}&language=pl-PL`);
      const movie = await res.json();

      const div = document.createElement("div");
      div.classList.add("liked-item");
      div.innerHTML = `
        <img src="https://image.tmdb.org/t/p/w300${movie.poster_path}" alt="${movie.title || movie.name}">
        <h4>${movie.title || movie.name}</h4>
      `;
      grid.appendChild(div);
    }));

    container.appendChild(grid);

  } catch (err) {
    console.error("B≈ÇƒÖd:", err);
    container.innerHTML = "<p>WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania wsp√≥lnych polubionych film√≥w.</p>";
  }
  document.querySelector(".buttons").style.display = "none"
  document.getElementById("swipeAgain").style.display = "inline-block"
  document.getElementById("swipeAgain").addEventListener("click", async () => {
  window.location.href = "swipeAgain.html";
});
}

async function startMutualSwipe(otherUser) {
    document.getElementById("swipeAgain").style.display = "none"
    document.querySelector(".buttons").style.display = "inline-block"
  try {
   
    const { data: myLikes, error: myError } = await supabaseClient
      .from("swipes")
      .select("movie_id, type")
      .eq("action", "liked")
      .eq("user_id", currentUser);

    if (myError) throw myError;

    // 2Ô∏è‚É£ Pobieramy polubione przez drugiego u≈ºytkownika
     // podaj tu id drugiego u≈ºytkownika
    const { data: otherLikes, error: otherError } = await supabaseClient
      .from("swipes")
      .select("movie_id, type")
      .eq("action", "liked")
      .eq("user_id", otherUser);

    if (otherError) throw otherError;

    const otherMovieIds = new Set(otherLikes.map(m => m.movie_id));

    // 3Ô∏è‚É£ Wsp√≥lne polubione filmy
    const mutualLikes = myLikes.filter(m => otherMovieIds.has(m.movie_id));

    if (!mutualLikes.length) {
      alert("Brak wsp√≥lnie polubionych film√≥w do swipe‚Äôowania üòÖ");
      return;
    }

    // 4Ô∏è‚É£ Resetujemy swipe
    sharedMovies = mutualLikes;
    currentIndex = 0;

    // 5Ô∏è‚É£ Czy≈õcimy stare swipes dla bie≈ºƒÖcego u≈ºytkownika
    const { error: delError } = await supabaseClient
      .from("swipes")
      .delete()
      .eq("user_id", currentUser);

    if (delError) console.error("B≈ÇƒÖd czyszczenia swipes:", delError);

    // 6Ô∏è‚É£ Poka≈º pierwszy film
    document.querySelector(".swiper-container").style.display = "block";
    document.getElementById("sharedListContainer").style.display = "none";
    showMovie(sharedMovies[currentIndex]);

  } catch (err) {
    console.error("B≈ÇƒÖd podczas ponownego swipe‚Äôowania:", err);
  }
}

    const footer = document.getElementById("footer");
    const footerToggle = document.getElementById("footerToggle");

    footerToggle.addEventListener("click", () => {
      footer.classList.toggle("open");
      footerToggle.classList.toggle("open");
    });
    document.getElementById("profileName").textContent = currentUser;
    document.getElementById("profilePicture").innerHTML = '<img src="../img/avatar'+currentUser+'.jpg" alt="">'
    // Toggle dropdown
    const profileBtn = document.getElementById("profileBtn");
    const dropdown = document.getElementById("dropdown");

    profileBtn.addEventListener("click", () => {
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    });

    document.getElementById("sharedListBtn").addEventListener("click", () => {
      // otw√≥rz nowƒÖ stronƒô np. shared.html
    window.location.href = "shared.html";

    });

    async function loadSharedMovies() {
    console.log(currentUser)
     try {
    // Usu≈Ñ wszystkie swipes dla bie≈ºƒÖcego u≈ºytkownika
    const { data, error } = await supabaseClient
      .from("swipes")
      .delete()
      .eq("user_id", currentUser);

    if (error) {
      console.error("B≈ÇƒÖd czyszczenia swipes:", error);
    } else {
      console.log("Swipes wyczyszczone:", data);
    }

  } catch (err) {
    console.error("Nieoczekiwany b≈ÇƒÖd:", err);
  }

document.querySelector(".swiper-container").style.display = "block"
document.getElementById("sharedListContainer").style.display = "none"
  const { data, error } = await supabaseClient.from("shared_list").select("*");

  if (error) {
    console.error("‚ùå B≈ÇƒÖd pobierania shared_list:", error);
    document.getElementById("movieCard").innerHTML = "<p>B≈ÇƒÖd pobierania film√≥w.</p>";
    return;
  }

  console.log("üìÄ Za≈Çadowano shared_list:", data);

  sharedMovies = data;
  if (sharedMovies.length === 0) {
    document.getElementById("movieCard").innerHTML = "<p>Brak film√≥w do swipe‚Äôowania üòû</p>";
  } else {
    currentIndex = 0;
    showMovie(sharedMovies[currentIndex]);
  }
}
    </script>
</body>
</html>
