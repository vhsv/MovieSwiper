<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MovieSwiper - Wyniki</title>
  <link rel="stylesheet" href="movieSwiper.css">
</head>
<body>
  <header>
    <h1>MOVIE SWIPER</h1>
    <div class="profile-menu">
      <button id="profileBtn"><span id="profilePicture"></span><span id="profileName"></span> <img src="../mainPage/img/arrowDown.png" alt="" id="arrowProfile"></button>
      <div id="dropdown" class="dropdown-content">
        <a href="#" id="sharedListBtn">Wsp√≥lna lista</a>
        <a href="#" id="logoutBtn">Wyloguj siƒô</a>
      </div>
    </div>
  </header>

  <div class="swiper-container">
    <div id="movieCard" class="movie-card"></div>
    <div class="buttons" style="display: none;">
      <button id="dislikeBtn">‚ùå Nie</button>
      <button id="likeBtn">‚ù§Ô∏è Tak</button>
    </div>
    <button id="swipeAgain">SWIPE AGAIN!</button>
  </div>

  <button id="footerToggle" class="footer-toggle"><img src="../mainPage/img/arrow.png" alt=""></button>

  <div id="footer" class="footer">
    <div class="footer-content">
      <h2>Menu</h2>
      <ul>
        <li><a href="../mainPage/mainSite.html"><img src="../mainPage/img/heart.png" alt="">Strona g≈Ç√≥wna</a></li>
        <li><a href="#">‚≠ê Najlepiej oceniane</a></li>
        <li><a href="#">üé¨ Ostatnio oglƒÖdane</a></li>
      </ul>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://hxaqbpcufdlzfhmgddds.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4YXFicGN1ZmRsemZobWdkZGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzY3ODQsImV4cCI6MjA3MjQxMjc4NH0.o38-3lqMWMAESf5I3oXaGXqTp1fXw6mkZ310b7-EhXo";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    const API_KEY = "9b02e967dce99b746fc634d03605d150";
    const currentUser = sessionStorage.getItem("currentUser") || "guest";
    let otherUser = currentUser == "Julcia" ? "Emi≈õ" : "Julcia";
    let sharedMovies = [];
    let currentIndex = 0;

    // DODAJ BRAKUJƒÑCE FUNKCJE:

    // Funkcja do pokazywania filmu
    async function showMovie(movieData) {
      if (!movieData) return;

      const movieId = movieData.movie_id;
      const type = movieData.type || "movie";

      const res = await fetch(`https://api.themoviedb.org/3/${type}/${movieId}?api_key=${API_KEY}&language=pl-PL`);
      const movie = await res.json();

      document.getElementById("movieCard").innerHTML = `
        <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" alt="${movie.title || movie.name}">
        <h2>${movie.title || movie.name}</h2>
      `;
    }

    // Funkcja do zapisywania swip√≥w
    async function saveSwipe(action) {
      const movie = sharedMovies[currentIndex];
      if (!movie) return;

      console.log("üíæ Zapisujƒô:", { user: currentUser, movie: movie.movie_id, action: action });

    const { error } = await supabaseClient.from("swipes").insert([
    {
      user_id: currentUser,
      movie_id: movie.movie_id,
      type: movie.type || "movie",
      action: action,
      round: currentRound // DODAJ RUNDƒò
    }
  ]);


      if (error) {
        console.error("‚ùå B≈ÇƒÖd zapisu:", error);
      } else {
        console.log("‚úÖ Zapisano swipe");
      }

      currentIndex++;
      if (currentIndex < sharedMovies.length) {
        showMovie(sharedMovies[currentIndex]);
      } else {
        console.log("üéâ KONIEC RUNDY - pokazujƒô wsp√≥lne liked");
        showLikedMovies(otherUser);
      }
    }

    // Funkcja do pokazywania wsp√≥lnych liked film√≥w
    async function showLikedMovies(otherUser) {
      const container = document.getElementById("movieCard");
      container.innerHTML = "<h2>≈Åadowanie wsp√≥lnych polubionych film√≥w...</h2>";

      try {
        const { data: myLikes, error: myError } = await supabaseClient
          .from("swipes")
          .select("movie_id, type")
          .eq("action", "liked")
          .eq("user_id", currentUser);

        if (myError) throw myError;

        const { data: otherLikes, error: otherError } = await supabaseClient
          .from("swipes")
          .select("movie_id, type")
          .eq("action", "liked")
          .eq("user_id", otherUser);

        if (otherError) throw otherError;

        if (!myLikes.length || !otherLikes.length) {
          container.innerHTML = "<p>Brak wsp√≥lnych polubionych film√≥w üòÖ</p>";
          return;
        }

        const myMovieIds = new Set(myLikes.map(m => m.movie_id));
        const mutualLikes = otherLikes.filter(m => myMovieIds.has(m.movie_id));

        if (mutualLikes.length === 0) {
          container.innerHTML = "<p>Brak wsp√≥lnych polubionych film√≥w üòÖ</p>";
          return;
        }

        // Je≈õli zosta≈Ç 1 film - KONIEC
        if (mutualLikes.length === 1) {
          const finalMovie = mutualLikes[0];
          const res = await fetch(`https://api.themoviedb.org/3/${finalMovie.type}/${finalMovie.movie_id}?api_key=${API_KEY}&language=pl-PL`);
          const movieData = await res.json();
          
          container.innerHTML = `
            <h2>üéâ ZWYCIƒòZCA! üéâ</h2>
            <div class="final-movie">
              <img src="https://image.tmdb.org/t/p/w500${movieData.poster_path}" alt="${movieData.title || movieData.name}">
              <h3>${movieData.title || movieData.name}</h3>
              <p>To wasz wsp√≥lnie wybrany film!</p>
            </div>
          `;
          document.querySelector(".buttons").style.display = "none";
          document.getElementById("swipeAgain").style.display = "none";
          return;
        }

        container.innerHTML = `<h2>üé¨ Wsp√≥lnie polubione filmy (${mutualLikes.length}):</h2>`;
        const grid = document.createElement("div");
        grid.classList.add("liked-grid");

        await Promise.all(mutualLikes.map(async item => {
          const res = await fetch(`https://api.themoviedb.org/3/${item.type}/${item.movie_id}?api_key=${API_KEY}&language=pl-PL`);
          const movie = await res.json();

          const div = document.createElement("div");
          div.classList.add("liked-item");
          div.innerHTML = `
            <img src="https://image.tmdb.org/t/p/w300${movie.poster_path}" alt="${movie.title || movie.name}">
            <h4>${movie.title || movie.name}</h4>
          `;
          grid.appendChild(div);
        }));

        container.appendChild(grid);

      } catch (err) {
        console.error("B≈ÇƒÖd:", err);
        container.innerHTML = "<p>WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania wsp√≥lnych polubionych film√≥w.</p>";
      }

      document.querySelector(".buttons").style.display = "none";
      document.getElementById("swipeAgain").style.display = "inline-block";
      
      document.getElementById("swipeAgain").onclick = async () => {
        await startNextSwipeRound(otherUser);
      };
    }

    let currentRound = 1;

async function startNextSwipeRound(otherUser) {
  try {
    currentRound++;
    console.log(`üîÑ Rozpoczynam rundƒô ${currentRound}`);

    // 1. Pobierz LIKED filmy z POPRZEDNIEJ rundy
    const { data: myLikes, error: myError } = await supabaseClient
      .from("swipes")
      .select("movie_id, type")
      .eq("action", "liked")
      .eq("user_id", currentUser)
      .eq("round", currentRound - 1); // Tylko z poprzedniej rundy!

    if (myError) throw myError;

    const { data: otherLikes, error: otherError } = await supabaseClient
      .from("swipes")
      .select("movie_id, type")
      .eq("action", "liked")
      .eq("user_id", otherUser)
      .eq("round", currentRound - 1); // Tylko z poprzedniej rundy!

    if (otherError) throw otherError;

    // Reszta kodu bez zmian...
    const myMovieIds = new Set(myLikes.map(m => m.movie_id));
    const mutualLikes = otherLikes.filter(m => myMovieIds.has(m.movie_id));

    if (mutualLikes.length === 0) {
      alert("Brak wsp√≥lnych liked film√≥w! üòÖ");
      return;
    }

    sharedMovies = mutualLikes;
    currentIndex = 0;

    document.querySelector(".swiper-container").style.display = "block";
    document.querySelector(".buttons").style.display = "block";
    document.getElementById("swipeAgain").style.display = "none";
    
    await showMovie(sharedMovies[currentIndex]);

  } catch (err) {
    console.error("‚ùå B≈ÇƒÖd:", err);
  }
}
    // Inicjalizacja
    document.addEventListener('DOMContentLoaded', function() {
      // Event listeners
      document.getElementById("likeBtn").addEventListener("click", () => saveSwipe("liked"));
      document.getElementById("dislikeBtn").addEventListener("click", () => saveSwipe("disliked"));
      
      // Zacznij od pokazania wsp√≥lnych film√≥w
      showLikedMovies(otherUser);
    });

  </script>
</body>
</html>