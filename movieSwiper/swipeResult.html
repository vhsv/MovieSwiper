<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MovieSwiper - Wyniki</title>
  <link rel="stylesheet" href="movieSwiper.css">
</head>
<body>
  <header>
    <h1>MOVIE SWIPER</h1>
    <div class="profile-menu">
      <button id="profileBtn"><span id="profilePicture"></span><span id="profileName"></span> <img src="../mainPage/img/arrowDown.png" alt="" id="arrowProfile"></button>
      <div id="dropdown" class="dropdown-content">
        <a href="#" id="sharedListBtn">Wsp√≥lna lista</a>
        <a href="#" id="logoutBtn">Wyloguj siƒô</a>
      </div>
    </div>
  </header>

  <div class="swiper-container">
    <div id="movieCard" class="movie-card"></div>
    <div class="buttons" style="display: none;">
      <button id="dislikeBtn">‚ùå Nie</button>
      <button id="likeBtn">‚ù§Ô∏è Tak</button>
    </div>
    <button id="swipeAgain">SWIPE AGAIN!</button>
  </div>

  <button id="footerToggle" class="footer-toggle"><img src="../mainPage/img/arrow.png" alt=""></button>

  <div id="footer" class="footer">
    <div class="footer-content">
      <h2>Menu</h2>
      <ul>
        <li><a href="../mainPage/mainSite.html"><img src="../mainPage/img/heart.png" alt="">Strona g≈Ç√≥wna</a></li>
        <li><a href="#">‚≠ê Najlepiej oceniane</a></li>
        <li><a href="#">üé¨ Ostatnio oglƒÖdane</a></li>
      </ul>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://hxaqbpcufdlzfhmgddds.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4YXFicGN1ZmRsemZobWdkZGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzY3ODQsImV4cCI6MjA3MjQxMjc4NH0.o38-3lqMWMAESf5I3oXaGXqTp1fXw6mkZ310b7-EhXo";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    const API_KEY = "9b02e967dce99b746fc634d03605d150";
    const currentUser = sessionStorage.getItem("currentUser") || "guest";
    let otherUser = currentUser == "Julcia" ? "Emi≈õ" : "Julcia";
    let sharedMovies = [];
    let currentIndex = 0;
    let currentRound = 1;

    // Funkcja do pokazywania filmu
    async function showMovie(movieData) {
      if (!movieData) return;

      const movieId = movieData.movie_id;
      const type = movieData.type || "movie";

      const res = await fetch(`https://api.themoviedb.org/3/${type}/${movieId}?api_key=${API_KEY}&language=pl-PL`);
      const movie = await res.json();

      document.getElementById("movieCard").innerHTML = `
        <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" alt="${movie.title || movie.name}">
        <h2>${movie.title || movie.name}</h2>
      `;
    }

    // Funkcja do zapisywania swip√≥w
    async function saveSwipe(action) {
      const movie = sharedMovies[currentIndex];
      if (!movie) return;

      console.log(`üíæ Zapisujƒô do rundy ${currentRound}:`, { 
        user: currentUser, 
        movie: movie.movie_id, 
        action: action 
      });

      const { error } = await supabaseClient.from("swipes").insert([
        {
          user_id: currentUser,
          movie_id: movie.movie_id,
          type: movie.type || "movie",
          action: action,
          round: currentRound
        }
      ]);

      if (error) {
        console.error("‚ùå B≈ÇƒÖd zapisu:", error);
      } else {
        console.log("‚úÖ Zapisano swipe");
      }

      currentIndex++;
      if (currentIndex < sharedMovies.length) {
        showMovie(sharedMovies[currentIndex]);
      } else {
        console.log("üéâ KONIEC RUNDY - pokazujƒô wsp√≥lne liked");
        showLikedMovies(otherUser);
      }
    }

    // Funkcja do sprawdzania gotowo≈õci
    async function checkBothUsersReady(otherUser) {
      try {
        console.log(`üîç checkBothUsersReady - runda ${currentRound}`);

        // Sprawd≈∫ czy oboje majƒÖ PRZYNAJMNIEJ 1 liked w tej rundzie
        const { data: myLikes, error: myError } = await supabaseClient
          .from("swipes")
          .select("movie_id")
          .eq("action", "liked")
          .eq("user_id", currentUser)
          .eq("round", currentRound);

        if (myError) throw myError;

        const { data: otherLikes, error: otherError } = await supabaseClient
          .from("swipes")
          .select("movie_id")
          .eq("action", "liked")
          .eq("user_id", otherUser)
          .eq("round", currentRound);

        if (otherError) throw otherError;

        const myCount = myLikes?.length || 0;
        const otherCount = otherLikes?.length || 0;

        console.log(`‚ù§Ô∏è ${currentUser} ma ${myCount} liked`);
        console.log(`‚ù§Ô∏è ${otherUser} ma ${otherCount} liked`);

        // Oboje gotowi je≈õli majƒÖ PRZYNAJMNIEJ 1 liked film
        const isReady = myCount > 0 && otherCount > 0;
        
        console.log("‚úÖ Oboje gotowi?:", isReady);
        return isReady;

      } catch (err) {
        console.error("‚ùå B≈ÇƒÖd sprawdzania gotowo≈õci:", err);
        return false;
      }
    }

    // Funkcja do pokazywania ekranu oczekiwania
    function showWaitingScreen(otherUser) {
      const container = document.getElementById("movieCard");
      container.innerHTML = `
        <h2>‚è≥ Oczekiwanie na drugiego u≈ºytkownika...</h2>
        <p>Czekam a≈º ${otherUser} te≈º zako≈Ñczy swipe'owanie</p>
        <div class="loading-spinner"></div>
        <button id="checkReadyBtn">Sprawd≈∫ czy gotowy</button>
      `;

      // USU≈É STAREGO LISTENERA i DODAJ NOWEGO
      const checkBtn = document.getElementById("checkReadyBtn");
      checkBtn.onclick = async () => {
        const isReady = await checkBothUsersReady(otherUser);
        if (isReady) {
          await startNextSwipeRound(otherUser);
        } else {
          alert("Druga osoba jeszcze nie jest gotowa!");
        }
      };
    }

    async function showLikedMovies(otherUser) {
      const container = document.getElementById("movieCard");
      container.innerHTML = "<h2>≈Åadowanie wsp√≥lnych polubionych film√≥w...</h2>";

      try {
        const { data: myLikes, error: myError } = await supabaseClient
          .from("swipes")
          .select("movie_id, type")
          .eq("action", "liked")
          .eq("user_id", currentUser)
          .eq("round", currentRound);

        if (myError) throw myError;

        const { data: otherLikes, error: otherError } = await supabaseClient
          .from("swipes")
          .select("movie_id, type")
          .eq("action", "liked")
          .eq("user_id", otherUser)
          .eq("round", currentRound);

        if (otherError) throw otherError;

        console.log(`‚ù§Ô∏è Moje liked z rundy ${currentRound}:`, myLikes);
        console.log(`‚ù§Ô∏è Jego liked z rundy ${currentRound}:`, otherLikes);

        if (!myLikes || myLikes.length === 0) {
          container.innerHTML = `
            <h2>Twoje wyniki rundy ${currentRound}</h2>
            <p>Nie polubi≈Çe≈õ ≈ºadnych film√≥w w tej rundzie üòÖ</p>
            <p><strong>Uwaga:</strong> Mo≈ºesz kontynuowaƒá, ale wyniki mogƒÖ siƒô r√≥≈ºniƒá od drugiej osoby</p>
            <button id="forceContinue">Kontynuuj mimo to</button>
          `;
          document.getElementById("forceContinue").onclick = async () => {
            await startNextSwipeRound(otherUser);
          };
          return;
        }

        if (!otherLikes || otherLikes.length === 0) {
          showWaitingScreen(otherUser);
          return;
        }

        const myMovieIds = new Set(myLikes.map(m => m.movie_id));
        const mutualLikes = otherLikes.filter(m => myMovieIds.has(m.movie_id));

        console.log("üéØ Wsp√≥lne liked:", mutualLikes);

        if (mutualLikes.length === 0) {
          container.innerHTML = `
            <h2>Wyniki rundy ${currentRound}</h2>
            <p>Brak wsp√≥lnych polubionych film√≥w üòÖ</p>
            <p>Ty polubi≈Çe≈õ: ${myLikes.length} film√≥w</p>
            <p>${otherUser} polubi≈Ç: ${otherLikes.length} film√≥w</p>
            <button id="forceContinue">Kontynuuj mimo to</button>
          `;
          document.getElementById("forceContinue").onclick = async () => {
            await startNextSwipeRound(otherUser);
          };
          return;
        }

        // Sprawd≈∫ czy oboje sƒÖ gotowi
        const isReady = await checkBothUsersReady(otherUser);
        
        if (!isReady) {
          container.innerHTML = `
            <h2>üé¨ Twoje wyniki rundy ${currentRound}:</h2>
            <p>Masz ${mutualLikes.length} wsp√≥lnych film√≥w</p>
            <p>‚è≥ Oczekiwanie na ${otherUser}...</p>
            <div class="loading-spinner"></div>
            <button id="checkReadyBtn">Sprawd≈∫ czy gotowy</button>
            <button id="forceContinue" style="margin-top: 10px;">Kontynuuj mimo to</button>
          `;

          document.getElementById("checkReadyBtn").onclick = async () => {
            const ready = await checkBothUsersReady(otherUser);
            if (ready) {
              await startNextSwipeRound(otherUser);
            } else {
              alert("Druga osoba jeszcze nie jest gotowa!");
            }
          };

          document.getElementById("forceContinue").onclick = async () => {
            await startNextSwipeRound(otherUser);
          };
          return;
        }

        // OBOJE GOTOWI - poka≈º wsp√≥lne filmy
        if (mutualLikes.length === 1) {
          const finalMovie = mutualLikes[0];
          const res = await fetch(`https://api.themoviedb.org/3/${finalMovie.type}/${finalMovie.movie_id}?api_key=${API_KEY}&language=pl-PL`);
          const movieData = await res.json();
          
          container.innerHTML = `
            <h2>üéâ ZWYCIƒòZCA! üéâ</h2>
            <div class="final-movie">
              <img src="https://image.tmdb.org/t/p/w500${movieData.poster_path}" alt="${movieData.title || movieData.name}">
              <h3>${movieData.title || movieData.name}</h3>
              <p>To wasz wsp√≥lnie wybrany film!</p>
            </div>
          `;
          document.querySelector(".buttons").style.display = "none";
          document.getElementById("swipeAgain").style.display = "none";
          return;
        }

        container.innerHTML = `<h2>üé¨ Wsp√≥lnie polubione filmy (${mutualLikes.length}):</h2>`;
        const grid = document.createElement("div");
        grid.classList.add("liked-grid");

        const uniqueMovies = [];
        const seenIds = new Set();
        
        for (const item of mutualLikes) {
          if (!seenIds.has(item.movie_id)) {
            seenIds.add(item.movie_id);
            uniqueMovies.push(item);
          }
        }

        await Promise.all(uniqueMovies.map(async item => {
          const res = await fetch(`https://api.themoviedb.org/3/${item.type}/${item.movie_id}?api_key=${API_KEY}&language=pl-PL`);
          const movie = await res.json();

          const div = document.createElement("div");
          div.classList.add("liked-item");
          div.innerHTML = `
            <img src="https://image.tmdb.org/t/p/w300${movie.poster_path}" alt="${movie.title || movie.name}">
            <h4>${movie.title || movie.name}</h4>
          `;
          grid.appendChild(div);
        }));

        container.appendChild(grid);

        // Poka≈º przycisk SWIPE AGAIN
        document.querySelector(".buttons").style.display = "none";
        document.getElementById("swipeAgain").style.display = "inline-block";
        
        document.getElementById("swipeAgain").onclick = async () => {
          await startNextSwipeRound(otherUser);
        };

      } catch (err) {
        console.error("B≈ÇƒÖd:", err);
        container.innerHTML = "<p>WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania wsp√≥lnych polubionych film√≥w.</p>";
      }
    }

    async function startNextSwipeRound(otherUser) {
      try {
        console.log(`üîÑ startNextSwipeRound - currentRound: ${currentRound}`);

        const { data: myLikes, error: myError } = await supabaseClient
          .from("swipes")
          .select("movie_id, type")
          .eq("action", "liked")
          .eq("user_id", currentUser)
          .eq("round", currentRound);

        if (myError) throw myError;

        const { data: otherLikes, error: otherError } = await supabaseClient
          .from("swipes")
          .select("movie_id, type")
          .eq("action", "liked")
          .eq("user_id", otherUser)
          .eq("round", currentRound);

        if (otherError) throw otherError;

        console.log(`‚ù§Ô∏è Moje liked z rundy ${currentRound}:`, myLikes);
        console.log(`‚ù§Ô∏è Jego liked z rundy ${currentRound}:`, otherLikes);

        const myMovieIds = new Set(myLikes.map(m => m.movie_id));
        const mutualLikes = otherLikes.filter(m => myMovieIds.has(m.movie_id));

        console.log("üéØ Wsp√≥lne liked:", mutualLikes);

        if (mutualLikes.length === 0) {
          alert("Brak wsp√≥lnych liked film√≥w z tej rundy! üòÖ");
          return;
        }

        // ZWIƒòKSZ rundƒô
        currentRound++;
        console.log(`üÜï Nowa runda: ${currentRound}`);

        sharedMovies = mutualLikes;
        currentIndex = 0;

        console.log("üé¨ Nowa lista do swipe:", sharedMovies);

        document.querySelector(".swiper-container").style.display = "block";
        document.querySelector(".buttons").style.display = "block";
        document.getElementById("swipeAgain").style.display = "none";
        
        await showMovie(sharedMovies[currentIndex]);

      } catch (err) {
        console.error("‚ùå B≈ÇƒÖd:", err);
      }
    }

    // Inicjalizacja
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById("likeBtn").addEventListener("click", () => saveSwipe("liked"));
      document.getElementById("dislikeBtn").addEventListener("click", () => saveSwipe("disliked"));
      showLikedMovies(otherUser);
    });
</script>
</body>
</html>